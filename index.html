<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dating App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/react-tinder-card/dist/react-tinder-card.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        .tinder-card {
            position: absolute;
            width: 100%;
            height: 100%;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
        }
        /* Simple styling for range inputs */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            background: #4a5568; /* gray-700 */
            border-radius: 5px;
            outline: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #ec4899; /* pink-500 */
            cursor: pointer;
            border-radius: 50%;
        }
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #ec4899; /* pink-500 */
            cursor: pointer;
            border-radius: 50%;
        }
    </style>
</head>
<body class="bg-[#0D1117]">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback, useRef, useContext, createContext } = React;
        const { createClient } = supabase;
        const TinderCard = window.ReactTinderCard;

        // --- Supabase Initialization ---
        // These are the details for your Supabase project. They should be checked if a new "Invalid API Key" error occurs.
        const supabaseUrl = 'https://fshypdupkmlcpdmcsxmr.supabase.co';
        // Updated to use the new Publishable key
        const supabaseAnonKey = 'sb_publishable_Kxmzd3qn-ILvc2BDy_6lAQ_5VIN6k9o';

        let supabaseClient;
        if (supabaseUrl && supabaseAnonKey) {
            supabaseClient = createClient(supabaseUrl, supabaseAnonKey);
        } else {
            console.error('Supabase URL or Anon Key is missing. Please provide valid credentials.');
        }

        // --- Supabase Context ---
        const SupabaseContext = createContext(null);
        const useSupabase = () => useContext(SupabaseContext);

        const SupabaseProvider = ({ children }) => {
            return (
                <SupabaseContext.Provider value={supabaseClient}>
                    {children}
                </SupabaseContext.Provider>
            );
        };

        // --- Helper Components & Icons ---
        const Logo = () => (
            <div className="flex flex-col items-center mb-8">
                <div className="flex items-center space-x-2">
                    <div className="text-5xl font-bold text-[#e93e77] flex items-center">
                        <span>Subs</span>
                    </div>
                    <div className="text-5xl font-bold text-[#b3b3c3] flex items-center">
                        <span>choice</span>
                    </div>
                </div>
            </div>
        );
        const AppIcon = (props) => (
             <img src="https://fshypdupkmlcpdmcsxmr.supabase.co/storage/v1/object/sign/avatars/Subschoice%20Logo%20Final.png?token=eyJraWQiOiJzdG9yYWdlLXVybC1zaWduaW5nLWtleV8wZGRlMTUyMS0xYWQwLTQ3YzUtODJiZi05OTE4NTQ1NWU1MWUiLCJhbGciOiJIUzI1NiJ9.eyJ1cmwiOiJhdmF0YXJzL1N1YnNjaG9pY2UgTG9nbyBGaW5hbC5wbmciLCJpYXQiOjE3NTYzMDg2NzcsImV4cCI6NDg3ODM3MjY3N30.dtdMHk_snefyW0k0xoNna6Q1SxIOo6qPl6_yiQPDPwQ" alt="App Icon" className="w-8 h-8" />
        );
        const EyeIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>;
        const EyeOffIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"/><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"/><line x1="2" x2="22" y1="2" y2="22"/></svg>;
        const ArrowLeftIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>;
        const HeartIcon = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>;
        const XIcon = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>;
        const MessageSquareIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>;
        const UserIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>;
        const SendIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>;
        const PaperclipIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l8.57-8.57A4 4 0 1 1 18 8.84l-8.59 8.59a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>;
        const MoreVerticalIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="1"/><circle cx="12" cy="5" r="1"/><circle cx="12" cy="19" r="1"/></svg>;
        const FilterIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>;
        const ShieldCheckIcon = () => <svg xmlns="http://www.w3.org/24/00/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><path d="m9 12 2 2 4-4"/></svg>;
        const HelpCircleIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/></svg>;
        const ThumbsUpIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M7 10v12"/><path d="M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.33 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2h0a2 2 0 0 1 3 1.88V10"/></svg>;
        const AlertTriangleIcon = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>;
        const ImageIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="m21 15-5-5L5 21"/></svg>;


        const Loader = () => <div className="flex justify-center items-center h-full w-full"><div className="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-pink-500"></div></div>;

        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-center p-4">
                    <div className="bg-gray-800 rounded-lg shadow-xl w-full max-w-md p-6">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-xl font-bold text-white">{title}</h3>
                            <button onClick={onClose} className="text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
                        </div>
                        <div>{children}</div>
                    </div>
                </div>
            );
        };

        const GalleryModal = ({ isOpen, onClose, username, imageUrls }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black bg-opacity-80 z-50 flex justify-center items-center p-4" onClick={onClose}>
                    <div className="bg-gray-800 rounded-lg shadow-xl w-full max-w-3xl p-6" onClick={e => e.stopPropagation()}>
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-xl font-bold text-white">{username}'s Gallery</h3>
                            <button onClick={onClose} className="text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
                        </div>
                        {imageUrls && imageUrls.length > 0 ? (
                            <div className="grid grid-cols-2 md:grid-cols-3 gap-4 max-h-[70vh] overflow-y-auto">
                                {imageUrls.map((url, index) => <img key={index} src={url} alt={`Gallery image ${index + 1}`} className="w-full h-full object-cover rounded-lg" />)}
                            </div>
                        ) : <p className="text-gray-400 text-center py-8">This user hasn't added any gallery photos.</p>}
                    </div>
                </div>
            );
        };


        // --- App Constants & Helpers ---
        const TYPE_1_LABELS = ["Dominant", "Domme", "Predator", "Primal", "Daddy", "Mommy", "Master", "Mistress", "Brat Tamer", "Rigger / Rope Top", "Findom", "Service top", "Owner", "White Knight", "Sadist", "Leather Dom", "Pleasure Dom", "Feeder", "Mentor", "Breeder"];
        const TYPE_2_LABELS = ["submissive", "prey", "little", "slave", "brat", "rope bunny", "finsub", "bottom", "pet", "princess", "damsel", "feedee", "cuck", "cuckqueen", "breeder"];
        const PREFERENCE_QUESTIONS = ["Kissing", "Masturbation", "Oral (recieving)", "Oral (Giving)", "Oral (CIM)", "Deepthroating", "Face Fucking", "Vaginal", "Anal", "Rimming", "Toys", "Edging", "Chastity", "Orgasm Denial", "Forced Orgasm", "Prostate Milking", "Post Orgasm Torture", "Body Worship", "Feet", "Armpits", "Genitals", "Role play", "Niple Play", "Bondage", "Gags", "Impact play", "Sensation play", "Torture play", "Sensory Deprivation", "Electro Stimulation", "Medical Play", "Watersports", "Breath Play", "Marks", "Psychological", "Photography", "Romatic Relationship", "Sexual Only"];
        const PREFERENCE_CHOICES = ["Yes", "Sometimes", "Irrelevant", "Not Preferred", "No"];
        const GENDERS = ["Male", "Female", "Non-binary", "Other", "Prefer not to say"];
        const BLOCKED_KEYWORDS = ["onlyfans", "fansly"];
        const PROFILE_PROMPTS = ["My ideal first scene is...", "A hard limit for me is...", "I feel most dominant/submissive when...", "Aftercare for me looks like..."];
        const REPORT_REASONS = ["Harassment", "Spam or Scams", "Inappropriate Photos", "Underage User", "Impersonation"];

        // --- All Components Go Here ---
        
        // --- Authentication Component ---
        const AuthScreen = () => {
            const [isLogin, setIsLogin] = useState(true);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [showPassword, setShowPassword] = useState(false);
            const [error, setError] = useState('');
            const [message, setMessage] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const supabase = useSupabase();

            const handleAuthAction = async (e) => {
                e.preventDefault();
                setIsLoading(true); setError(''); setMessage('');
                if (!email || !password) { setError("Please fill in all fields."); setIsLoading(false); return; }
                
                try {
                    let response;
                    if (isLogin) {
                        response = await supabase.auth.signInWithPassword({ email, password });
                    } else {
                        response = await supabase.auth.signUp({ 
                            email, 
                            password,
                            options: {
                                emailRedirectTo: window.location.href,
                            }
                        });
                        if (response.data.user && !response.error) {
                            setMessage("Confirmation email sent! Please check your inbox to verify your account.");
                        }
                    }
                    if (response.error) throw response.error;

                } catch (err) { setError(err.message); } 
                finally { setIsLoading(false); }
            };
            
            const handlePasswordReset = async () => {
                if (!email) { setError("Please enter your email to reset password."); return; }
                setIsLoading(true); setError(''); setMessage('');
                try {
                    const { error } = await supabase.auth.resetPasswordForEmail(email, {
                        redirectTo: window.location.href,
                    });
                    if (error) throw error;
                    setMessage("Password reset email sent! Check your inbox.");
                } catch (err) { setError(err.message); } 
                finally { setIsLoading(false); }
            };

            return (
                <div className="min-h-screen text-white flex flex-col justify-center items-center p-4">
                    <div className="w-full max-w-md">
                        <Logo />
                        <div className="bg-[#161B22] p-8 rounded-lg shadow-lg">
                            <div className="flex mb-6 relative">
                                <button onClick={() => setIsLogin(true)} className={`w-1/2 pb-3 font-semibold ${isLogin ? 'text-pink-500' : 'text-gray-400'}`}>Login</button>
                                <button onClick={() => setIsLogin(false)} className={`w-1/2 pb-3 font-semibold ${!isLogin ? 'text-pink-500' : 'text-gray-400'}`}>Sign Up</button>
                                <div className={`absolute bottom-0 h-0.5 bg-pink-500 transition-all duration-300 ${isLogin ? 'left-0 w-1/2' : 'left-1/2 w-1/2'}`}></div>
                            </div>
                             <hr className="border-gray-700 -mt-6 mb-6" />
                            {error && <p className="bg-red-500/20 text-red-400 p-3 rounded-md mb-4 text-center">{error}</p>}
                            {message && <p className="bg-green-500/20 text-green-400 p-3 rounded-md mb-4 text-center">{message}</p>}
                            <form onSubmit={handleAuthAction} className="space-y-6">
                                <div>
                                    <label className="block text-gray-400 mb-2 text-sm">Email</label>
                                    <input type="email" value={email} onChange={(e) => setEmail(e.target.value)} className="w-full bg-[#0D1117] border border-gray-700 rounded-md p-3 focus:outline-none focus:ring-2 focus:ring-pink-500" />
                                </div>
                                <div>
                                    <label className="block text-gray-400 mb-2 text-sm">Password</label>
                                    <div className="relative">
                                        <input 
                                            type={showPassword ? 'text' : 'password'} 
                                            value={password} 
                                            onChange={(e) => setPassword(e.target.value)} 
                                            className="w-full bg-[#0D1117] border border-gray-700 rounded-md p-3 pr-10 focus:outline-none focus:ring-2 focus:ring-pink-500" 
                                        />
                                        <button 
                                            type="button" 
                                            onClick={() => setShowPassword(!showPassword)} 
                                            className="absolute inset-y-0 right-0 px-3 flex items-center text-gray-400 hover:text-white"
                                        >
                                            {showPassword ? <EyeOffIcon /> : <EyeIcon />}
                                        </button>
                                    </div>
                                </div>
                                <button type="submit" disabled={isLoading} className="w-full bg-pink-600 hover:bg-pink-700 rounded-md p-3 font-bold transition-colors disabled:bg-gray-500 flex justify-center items-center h-12">{isLoading ? <Loader/> : (isLogin ? 'Login' : 'Create Account')}</button>
                            </form>
                            {isLogin && <div className="text-center mt-4"><button onClick={handlePasswordReset} className="text-sm text-pink-400 hover:underline">Forgot Password?</button></div>}
                        </div>
                    </div>
                </div>
            );
        };

        // --- Onboarding Component ---
        const OnboardingFlow = ({ user }) => {
            const [step, setStep] = useState(1);
            const [aboutStep, setAboutStep] = useState(1); // Sub-step for step 2
            const [userData, setUserData] = useState({
                profileType: '', labels: [], username: '', birthdate: '', gender: '',
                bio: '', socialLinks: { fetlife: '', reddit: '', instagram: '' },
                profilePic: null, galleryPics: [], preferences: {}, location: null,
                looking_for_labels: [], prompts: {}
            });
            const [isLoading, setIsLoading] = useState(false);
            const [error, setError] = useState('');
            const [preferenceStep, setPreferenceStep] = useState(0);
            const [roleChoice, setRoleChoice] = useState(null);
            const [usernameStatus, setUsernameStatus] = useState('idle'); // idle, checking, available, taken
            const supabase = useSupabase();

            // Debounced username check
            useEffect(() => {
                const checkUsername = async () => {
                    if (userData.username.length < 3) {
                        setUsernameStatus('idle');
                        return;
                    }
                    setUsernameStatus('checking');
                    const { data, error } = await supabase
                        .from('usernames')
                        .select('user_id')
                        .eq('username', userData.username.toLowerCase())
                        .single();
                    
                    if (data) {
                        setUsernameStatus('taken');
                    } else {
                        setUsernameStatus('available');
                    }
                };

                const handler = setTimeout(() => {
                    checkUsername();
                }, 500); // 500ms delay

                return () => {
                    clearTimeout(handler);
                };
            }, [userData.username, supabase]);

            const nextStep = () => setStep(s => s + 1);
            const prevStep = () => {
                if (step === 3 && aboutStep > 1) {
                    setAboutStep(s => s - 1);
                } else if (step > 1) {
                    setStep(s => s - 1);
                }
            };

            const handleRoleChoice = (choice) => {
                setRoleChoice(choice);
                setUserData(prev => ({
                    ...prev,
                    profileType: choice === 'Dominant' ? 'Type 1' : 'Type 2',
                    labels: [], // Clear labels when role changes
                    looking_for_labels: []
                }));
            };

            const handleLabelSelection = (label) => {
                setUserData(prev => ({
                    ...prev,
                    labels: prev.labels.includes(label)
                        ? prev.labels.filter(l => l !== label)
                        : [...prev.labels, label],
                }));
            };
            
            const handleLookingForSelection = (label) => {
                setUserData(prev => ({
                    ...prev,
                    looking_for_labels: prev.looking_for_labels.includes(label)
                        ? prev.looking_for_labels.filter(l => l !== label)
                        : [...prev.looking_for_labels, label],
                }));
            };
            
            const handlePromptChange = (prompt, answer) => {
                setUserData(prev => ({
                    ...prev,
                    prompts: { ...prev.prompts, [prompt]: answer }
                }));
            };


            const clearRoleChoice = () => {
                setRoleChoice(null);
                setUserData(prev => ({ ...prev, profileType: '', labels: [] }));
                setError('');
            };
            
            const handlePreferenceSelection = (question, choice) => {
                setUserData(prevUserData => {
                    const newPreferences = { ...prevUserData.preferences };
                    newPreferences[question] = choice;
                    return {
                        ...prevUserData,
                        preferences: newPreferences
                    };
                });
            };

            const handleFinalSubmit = async () => {
                setIsLoading(true);
                setError('');
                
                if (!userData.username || !userData.birthdate || !userData.gender || !userData.bio || !userData.profilePic || !userData.profileType || userData.labels.length === 0 || userData.looking_for_labels.length === 0) {
                    setError("Please ensure all fields on previous steps are complete.");
                    if (!userData.profileType || userData.labels.length === 0) setStep(1);
                    else if (userData.looking_for_labels.length === 0) setStep(2);
                    else setStep(3);
                    setIsLoading(false);
                    return;
                }
                if (usernameStatus !== 'available') {
                    setError("Please choose an available username.");
                    setStep(3);
                    setAboutStep(1);
                    setIsLoading(false);
                    return;
                }

                try {
                    // Upload profile picture
                    const profilePicPath = `${user.id}/${Date.now()}_${userData.profilePic.name}`;
                    const { error: uploadError } = await supabase.storage
                        .from('avatars')
                        .upload(profilePicPath, userData.profilePic);
                    if(uploadError) throw uploadError;
                    
                    const { data: { publicUrl: profilePicUrl } } = supabase.storage
                        .from('avatars')
                        .getPublicUrl(profilePicPath);

                    const finalProfile = {
                        id: user.id,
                        email: user.email,
                        profile_type: userData.profileType,
                        labels: userData.labels,
                        username: userData.username,
                        birthdate: userData.birthdate,
                        gender: userData.gender,
                        bio: userData.bio,
                        // Fix: Use the userData.socialLinks state object
                        social_links: userData.socialLinks,
                        profile_pic_url: profilePicUrl,
                        gallery_urls: [],
                        preferences: userData.preferences,
                        looking_for_labels: userData.looking_for_labels,
                        prompts: userData.prompts
                    };
                    
                    const { error: profileError } = await supabase.from('profiles').insert(finalProfile);
                    if(profileError) throw profileError;

                    const { error: usernameInsertError } = await supabase.from('usernames').insert({
                        username: userData.username.toLowerCase(),
                        user_id: user.id
                    });
                    if(usernameInsertError) throw usernameInsertError;

                } catch (err) {
                    console.error("Onboarding Error:", err);
                    setError(`An error occurred: ${err.message}`);
                } finally {
                    setIsLoading(false);
                }
            };

            const renderStepContent = () => {
                switch(step) {
                    case 1: // Choose Role & Labels
                         if (!roleChoice) {
                            return (
                                <div>
                                    <h2 className="text-2xl font-bold mb-2">Choose Your Role</h2>
                                    <p className="text-gray-400 mb-6">This will help us tailor your experience.</p>
                                    <div className="space-y-4">
                                        <button onClick={() => handleRoleChoice('Dominant')} className="w-full text-left p-6 rounded-lg bg-blue-900/50 border border-blue-700 hover:bg-blue-900/80 transition-colors">
                                            <h3 className="text-xl font-bold text-blue-400">Dominant</h3>
                                            <p className="text-gray-300">For Dominant seeking submissive</p>
                                        </button>
                                        <button onClick={() => handleRoleChoice('submissive')} className="w-full text-left p-6 rounded-lg bg-pink-900/50 border border-pink-700 hover:bg-pink-900/80 transition-colors">
                                            <h3 className="text-xl font-bold text-pink-400">submissive</h3>
                                            <p className="text-gray-300">For submissive seeking Dominant</p>
                                        </button>
                                    </div>
                                </div>
                            );
                        }
                        return (
                            <div>
                                <h2 className="text-2xl font-bold mb-2">{roleChoice === 'Dominant' ? 'Dominant Type' : 'Submissive Type'}</h2>
                                <p className="text-gray-400 mb-6">Select one or more roles you identify as.</p>
                                {roleChoice === 'Dominant' && (
                                    <div className="mb-4">
                                        <h3 className="font-semibold text-lg text-blue-400 mb-2">Dominant Roles</h3>
                                        <div className="flex flex-wrap gap-2">
                                            {TYPE_1_LABELS.map(label => (
                                                <button key={label} onClick={() => handleLabelSelection(label)} className={`px-3 py-1 rounded-full text-sm transition-colors ${userData.labels.includes(label) ? 'bg-blue-600 text-white' : 'bg-gray-700 text-gray-300'}`}>{label}</button>
                                            ))}
                                        </div>
                                    </div>
                                )}
                                {roleChoice === 'submissive' && (
                                    <div className="mb-6">
                                        <h3 className="font-semibold text-lg text-pink-400 mb-2">Submissive Roles</h3>
                                        <div className="flex flex-wrap gap-2">
                                            {TYPE_2_LABELS.map(label => (
                                                <button key={label} onClick={() => handleLabelSelection(label)} className={`px-3 py-1 rounded-full text-sm transition-colors ${userData.labels.includes(label) ? 'bg-pink-600 text-white' : 'bg-gray-700 text-gray-300'}`}>{label}</button>
                                            ))}
                                        </div>
                                    </div>
                                )}
                                <div className="text-center mt-6">
                                    <button onClick={clearRoleChoice} className="text-sm text-gray-400 hover:underline">Change Role</button>
                                </div>
                            </div>
                        );
                    case 2: // Choose Partner Labels
                        return (
                            <div>
                                <h2 className="text-2xl font-bold mb-2">Who Are You Looking For?</h2>
                                <p className="text-gray-400 mb-6">Select the labels that interest you in a partner.</p>
                                {userData.profileType === 'Type 1' && (
                                    <div className="flex flex-wrap gap-2">
                                        {TYPE_2_LABELS.map(label => (
                                            <button key={label} onClick={() => handleLookingForSelection(label)} className={`px-3 py-1 rounded-full text-sm transition-colors ${userData.looking_for_labels.includes(label) ? 'bg-pink-600 text-white' : 'bg-gray-700 text-gray-300'}`}>{label}</button>
                                        ))}
                                    </div>
                                )}
                                {userData.profileType === 'Type 2' && (
                                    <div className="flex flex-wrap gap-2">
                                        {TYPE_1_LABELS.map(label => (
                                            <button key={label} onClick={() => handleLookingForSelection(label)} className={`px-3 py-1 rounded-full text-sm transition-colors ${userData.looking_for_labels.includes(label) ? 'bg-blue-600 text-white' : 'bg-gray-700 text-gray-300'}`}>{label}</button>
                                        ))}
                                    </div>
                                )}
                            </div>
                        );
                    case 3: // Basics & Bio & Socials
                        switch (aboutStep) {
                            case 1:
                                return (
                                    <div>
                                        <h2 className="text-2xl font-bold mb-6">The Basics</h2>
                                        <div className="space-y-4">
                                            <div>
                                                <input type="text" placeholder="Unique Username" value={userData.username} onChange={e => setUserData({...userData, username: e.target.value})} className="w-full bg-gray-700 p-3 rounded-md" />
                                                <div className="text-sm mt-1 h-5">
                                                    {usernameStatus === 'checking' && <p className="text-yellow-400">Checking...</p>}
                                                    {usernameStatus === 'available' && <p className="text-green-400">Available!</p>}
                                                    {usernameStatus === 'taken' && <p className="text-red-400">Username is taken.</p>}
                                                </div>
                                            </div>
                                            <div>
                                                <label className="block text-gray-400 text-sm">Birthdate (You must be 18+)</label>
                                                <input type="date" value={userData.birthdate} onChange={e => {
                                                    const birthDate = new Date(e.target.value);
                                                    const today = new Date();
                                                    let age = today.getFullYear() - birthDate.getFullYear();
                                                    const m = today.getMonth() - birthDate.getMonth();
                                                    if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) age--;
                                                    if (age < 18) setError("You must be 18 or older to join.");
                                                    else setError("");
                                                    setUserData({...userData, birthdate: e.target.value});
                                                }} className="w-full bg-gray-700 p-3 rounded-md" />
                                            </div>
                                            <select value={userData.gender} onChange={e => setUserData({...userData, gender: e.target.value})} className="w-full bg-gray-700 p-3 rounded-md">
                                                <option value="">Select Gender</option>
                                                {GENDERS.map(g => <option key={g} value={g}>{g}</option>)}
                                            </select>
                                        </div>
                                    </div>
                                );
                            case 2:
                                return (
                                    <div>
                                        <h2 className="text-2xl font-bold mb-6">Your Bio</h2>
                                        <p className="text-gray-400 mb-2">Explain what your role means to you, how you uphold those statements and what makes you the kind of partner someone should chose.</p>
                                        <textarea placeholder="Tell us about yourself..." value={userData.bio} onChange={e => setUserData({...userData, bio: e.target.value})} className="w-full bg-gray-700 p-3 rounded-md h-48"></textarea>
                                    </div>
                                );
                            case 3:
                                return (
                                    <div>
                                        <h2 className="text-2xl font-bold mb-6">Social Links (Optional)</h2>
                                        <div className="space-y-4">
                                            <input type="text" placeholder="Fetlife Profile URL" value={userData.socialLinks.fetlife} onChange={e => setUserData(prev => ({ ...prev, socialLinks: { ...prev.socialLinks, fetlife: e.target.value } }))} className="w-full bg-gray-700 p-3 rounded-md" />
                                            <input type="text" placeholder="Reddit Profile URL" value={userData.socialLinks.reddit} onChange={e => setUserData(prev => ({ ...prev, socialLinks: { ...prev.socialLinks, reddit: e.target.value } }))} className="w-full bg-gray-700 p-3 rounded-md" />
                                            <input type="text" placeholder="Instagram Profile URL" value={userData.socialLinks.instagram} onChange={e => setUserData(prev => ({ ...prev, socialLinks: { ...prev.socialLinks, instagram: e.target.value } }))} className="w-full bg-gray-700 p-3 rounded-md" />
                                        </div>
                                    </div>
                                );
                            default: return null;
                        }
                    case 4: // Photos
                        return (
                            <div>
                                <h2 className="text-2xl font-bold mb-6">Upload Your Photos</h2>
                                <div className="mb-6">
                                    <label className="block text-gray-400 mb-2">Profile Picture (Required)</label>
                                    <p className="text-sm text-gray-500 mb-2">This will be shown to users after a match.</p>
                                    <input type="file" accept="image/*" onChange={e => setUserData({...userData, profilePic: e.target.files[0]})} className="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-pink-50 file:text-pink-700 hover:file:bg-pink-100"/>
                                    {userData.profilePic && <p className="text-green-400 mt-2">Selected: {userData.profilePic.name}</p>}
                                </div>
                                <div>
                                    <label className="block text-gray-400 mb-2">Gallery Pictures (Up to 5, Optional)</label>
                                     <p className="text-sm text-gray-500 mb-2">These are only shared when you grant access in a chat.</p>
                                    <input type="file" accept="image/*" multiple onChange={e => setUserData({...userData, galleryPics: [...e.target.files].slice(0, 5)})} className="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-pink-50 file:text-pink-700 hover:file:bg-pink-100"/>
                                     <div className="mt-2 text-green-400">
                                        {userData.galleryPics.map(p => <p key={p.name}>{p.name}</p>)}
                                    </div>
                                </div>
                            </div>
                        );
                    case 5: // Profile Prompts
                        return (
                            <div>
                                <h2 className="text-2xl font-bold mb-2">Answer Some Prompts</h2>
                                <p className="text-gray-400 mb-6">Let your personality shine. Answer at least one.</p>
                                <div className="space-y-4">
                                    {PROFILE_PROMPTS.map(prompt => (
                                        <div key={prompt}>
                                            <label className="block text-gray-300 mb-1 font-semibold">{prompt}</label>
                                            <textarea 
                                                onChange={e => handlePromptChange(prompt, e.target.value)}
                                                value={userData.prompts[prompt] || ''}
                                                className="w-full bg-gray-700 p-2 rounded-md h-20"
                                            ></textarea>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        );
                    case 6: // Preferences
                        const currentQuestion = PREFERENCE_QUESTIONS[preferenceStep];
                        const nextPreference = () => setPreferenceStep(p => Math.min(p + 1, PREFERENCE_QUESTIONS.length - 1));
                        const prevPreference = () => setPreferenceStep(p => Math.max(p - 1, 0));

                        return (
                            <div>
                                <h2 className="text-2xl font-bold mb-2">Set Your Preferences</h2>
                                <p className="text-gray-400 mb-6">This helps us find your best matches.</p>
                                
                                <div className="bg-gray-800 p-6 rounded-lg shadow-inner min-h-[250px] flex flex-col justify-between">
                                    <div>
                                        <div className="flex justify-between items-center mb-4">
                                            <h3 className="text-xl font-semibold text-pink-400">{currentQuestion}</h3>
                                            <span className="text-sm text-gray-400">{preferenceStep + 1} / {PREFERENCE_QUESTIONS.length}</span>
                                        </div>
                                        <div className="flex flex-wrap gap-2 justify-center py-4">
                                            {PREFERENCE_CHOICES.map(c => (
                                                <button 
                                                    key={c} 
                                                    onClick={() => {
                                                        handlePreferenceSelection(currentQuestion, c);
                                                        if (preferenceStep < PREFERENCE_QUESTIONS.length - 1) {
                                                            setTimeout(() => nextPreference(), 200);
                                                        }
                                                    }} 
                                                    className={`px-4 py-2 text-md rounded-full transition-transform transform hover:scale-105 ${userData.preferences[currentQuestion] === c ? 'bg-pink-600 text-white shadow-lg' : 'bg-gray-700 text-gray-300'}`}>
                                                    {c}
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                    <div className="flex justify-between mt-6">
                                        <button onClick={prevPreference} disabled={preferenceStep === 0} className="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-md disabled:opacity-50">
                                            Previous
                                        </button>
                                        <button onClick={nextPreference} disabled={preferenceStep === PREFERENCE_QUESTIONS.length - 1} className="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-md disabled:opacity-50">
                                            Next
                                        </button>
                                    </div>
                                </div>
                            </div>
                        );
                    default: return null;
                }
            };
            
            const canProceed = () => {
                if (step === 3) {
                    if (aboutStep === 1) {
                        return userData.username && userData.birthdate && userData.gender && !error && usernameStatus === 'available';
                    }
                    if (aboutStep === 2) {
                        return userData.bio;
                    }
                    if (aboutStep === 3) {
                        return true;
                    }
                }
                switch(step) {
                    case 1: return userData.profileType !== '' && userData.labels.length > 0;
                    case 2: return userData.looking_for_labels.length > 0;
                    case 4: return userData.profilePic !== null;
                    case 5: return Object.values(userData.prompts).some(answer => answer.trim() !== ''); // At least one prompt answered
                    case 6: return true;
                    default: return false;
                }
            };

            const handleNextStep = () => {
                if (step === 3 && aboutStep < 3) {
                    setAboutStep(s => s + 1);
                } else {
                    setAboutStep(1); // Reset sub-step when changing main steps
                    nextStep();
                }
            };

            let progressBarWidth = ((step - 1) / 6) * 100;
            if (step === 3) { // Basics step
                 progressBarWidth = ((2 / 6) * 100) + (aboutStep / 3 * (1/6 * 100));
            }
            if (step === 6) { // Preferences step
                const preferenceProgress = (preferenceStep / (PREFERENCE_QUESTIONS.length -1));
                progressBarWidth = ((5 / 6) * 100) + (preferenceProgress * (1/6 * 100));
            }


            return (
                <div className="min-h-screen bg-gray-900 text-white flex flex-col justify-center items-center p-4">
                    <div className="w-full max-w-lg bg-gray-800 p-8 rounded-lg shadow-lg">
                        <div className="relative h-2 bg-gray-700 rounded-full mb-8">
                            <div className="absolute top-0 left-0 h-2 bg-pink-500 rounded-full transition-all duration-500" style={{ width: `${progressBarWidth}%` }}></div>
                        </div>
                        {error && <p className="bg-red-500/20 text-red-400 p-3 rounded-md mb-4">{error}</p>}
                        <div className="min-h-[400px]">{renderStepContent()}</div>
                        <div className="flex justify-between mt-8">
                            <button onClick={prevStep} disabled={step === 1 && aboutStep === 1} className="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-md disabled:opacity-50">Back</button>
                            {(step < 6 && (step !== 3 || aboutStep < 3)) ? (
                                <button onClick={handleNextStep} disabled={!canProceed()} className="bg-pink-600 hover:bg-pink-700 text-white font-bold py-2 px-4 rounded-md disabled:opacity-50 disabled:cursor-not-allowed">Next</button>
                            ) : (
                                <button onClick={handleFinalSubmit} disabled={isLoading || !canProceed()} className="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md disabled:opacity-50">
                                    {isLoading ? 'Saving...' : 'Finish & Find Matches'}
                                </button>
                            )}
                        </div>
                    </div>
                </div>
            );
        };


        // --- Main Application Component ---
        const MainApp = ({ user, userProfile, setUserProfile }) => {
            const [activeTab, setActiveTab] = useState('finder');
            const [activeChat, setActiveChat] = useState(null); // Will hold the partner's profile and match ID
            const [activePost, setActivePost] = useState(null); // Will hold the post object for detail view
            const supabase = useSupabase();
            
            const handleLogout = async () => { await supabase.auth.signOut(); };

            useEffect(() => {
                if (userProfile && !userProfile.location) {
                    navigator.geolocation.getCurrentPosition(
                        async (position) => {
                            const { latitude, longitude } = position.coords;
                            const { error } = await supabase.from('profiles').update({ location: `POINT(${longitude} ${latitude})` }).eq('id', user.id)
                            if (error) console.error("Error updating location:", error);
                        },
                        (error) => console.error("Error getting location:", error)
                    );
                }
            }, [userProfile, supabase, user.id]);

            const renderContent = () => {
                if (activeChat) return <ChatScreen userProfile={userProfile} partner={activeChat.partner} matchId={activeChat.matchId} goBack={() => setActiveChat(null)} />;
                if (activePost) return <PostDetailScreen userProfile={userProfile} post={activePost} goBack={() => setActivePost(null)} />;
                switch(activeTab) {
                    case 'finder': return <Finder userProfile={userProfile} />;
                    case 'messages': return <MessagesScreen userProfile={userProfile} onChatSelect={setActiveChat} />;
                    case 'forum': return <ForumScreen userProfile={userProfile} onPostSelect={setActivePost} />;
                    case 'profile': return <ProfileScreen userProfile={userProfile} onLogout={handleLogout} />;
                    default: return <Finder userProfile={userProfile} />;
                }
            };

            return (
                <div className="h-screen w-screen bg-gray-900 text-white flex flex-col font-sans">
                    <div className="flex-grow overflow-y-auto">{renderContent()}</div>
                    {!activeChat && !activePost && (
                        <nav className="flex justify-around bg-gray-800 p-2 shadow-lg">
                            <button onClick={() => setActiveTab('finder')} className={`p-2 rounded-lg ${activeTab === 'finder' ? 'text-pink-500' : 'text-gray-400'}`}><AppIcon /></button>
                            <button onClick={() => setActiveTab('messages')} className={`p-2 rounded-lg ${activeTab === 'messages' ? 'text-pink-500' : 'text-gray-400'}`}><MessageSquareIcon /></button>
                            <button onClick={() => setActiveTab('forum')} className={`p-2 rounded-lg ${activeTab === 'forum' ? 'text-pink-500' : 'text-gray-400'}`}><HelpCircleIcon /></button>
                            <button onClick={() => setActiveTab('profile')} className={`p-2 rounded-lg ${activeTab === 'profile' ? 'text-pink-500' : 'text-gray-400'}`}><UserIcon /></button>
                        </nav>
                    )}
                </div>
            );
        };
        
        // --- Filter Modal for Finder ---
        const FilterModal = ({ isOpen, onClose, currentFilters, onApply }) => {
            const [filters, setFilters] = useState(currentFilters);

            useEffect(() => {
                setFilters(currentFilters);
            }, [currentFilters]);

            const handleApply = () => {
                onApply(filters);
                onClose();
            };

            return (
                <Modal isOpen={isOpen} onClose={onClose} title="Filter Options">
                    <div className="space-y-6 text-white">
                        <div>
                            <label className="block text-gray-400 mb-2">Distance: <span className="font-bold text-pink-400">{filters.distance} km</span></label>
                            <input type="range" min="10" max="500" value={filters.distance} onChange={e => setFilters({...filters, distance: parseInt(e.target.value)})} />
                        </div>
                        <div>
                            <label className="block text-gray-400 mb-2">Age Range: <span className="font-bold text-pink-400">{filters.minAge} - {filters.maxAge}</span></label>
                            <div className="flex items-center space-x-4">
                                <input type="range" min="18" max={filters.maxAge} value={filters.minAge} onChange={e => setFilters({...filters, minAge: parseInt(e.target.value)})} />
                                <input type="range" min={filters.minAge} max="80" value={filters.maxAge} onChange={e => setFilters({...filters, maxAge: parseInt(e.target.value)})} />
                            </div>
                        </div>
                        <button onClick={handleApply} className="w-full bg-pink-600 hover:bg-pink-700 text-white font-bold py-2 px-4 rounded-md">Apply Filters</button>
                    </div>
                </Modal>
            );
        };


        // --- Finder Screen Component ---
        const Finder = ({ userProfile }) => {
            const [profiles, setProfiles] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState('');
            const [matchNotification, setMatchNotification] = useState(null);
            const [isFilterModalOpen, setFilterModalOpen] = useState(false);
            const [filters, setFilters] = useState({ distance: 100, minAge: 18, maxAge: 55 });
            const supabase = useSupabase();
            const childRefs = useMemo(() => Array(profiles.length).fill(0).map(i => React.createRef()), [profiles]);
            const currentIndexRef = useRef(profiles.length - 1);

            const fetchProfiles = useCallback(async (appliedFilters) => {
                setLoading(true);
                setError('');
                try {
                    // IMPORTANT: You need to create this RPC function in your Supabase SQL editor.
                    const { data, error: rpcError } = await supabase.rpc('get_filtered_profiles', {
                        distance_km: appliedFilters.distance,
                        min_age_years: appliedFilters.minAge,
                        max_age_years: appliedFilters.maxAge
                    });

                    if (rpcError) throw rpcError;
                    
                    setProfiles(data || []);
                    currentIndexRef.current = (data?.length || 0) - 1;

                } catch (err) {
                    setError('Failed to load profiles. Ensure the `get_filtered_profiles` RPC function is set up in your Supabase project.');
                    console.error(err);
                } finally {
                    setLoading(false);
                }
            }, [supabase]);

            useEffect(() => {
                if (userProfile.location) {
                    fetchProfiles(filters);
                } else {
                     setError("Please enable location services to find matches.");
                     setLoading(false);
                }
            }, [fetchProfiles, userProfile.location]);


            const swiped = async (direction, swipedUserId, index) => {
                currentIndexRef.current = index - 1;
                if (direction === 'right') {
                    const { data, error } = await supabase.rpc('handle_like_swipe', {
                        target_user_id: swipedUserId
                    });
                    if (error) console.error("Error handling like:", error);
                    if (data === true) { // RPC returns true on a match
                        const matchedUser = profiles.find(p => p.id === swipedUserId);
                        setMatchNotification(matchedUser?.username || 'Someone');
                        setTimeout(() => setMatchNotification(null), 4000);
                    }
                } else if (direction === 'left') {
                    await supabase.from('swipes').insert({
                        swiper_id: userProfile.id,
                        swiped_id: swipedUserId,
                        liked: false
                    });
                }
            };
            
            const swipe = async (dir) => {
                if (currentIndexRef.current >= 0) {
                    await childRefs[currentIndexRef.current].current.swipe(dir);
                }
            };

            const handleApplyFilters = (newFilters) => {
                setFilters(newFilters);
                fetchProfiles(newFilters);
            };

            return (
                <div className="flex flex-col h-full w-full items-center justify-center bg-gray-900">
                     {matchNotification && (
                        <div className="absolute top-5 z-50 bg-green-500 text-white py-3 px-6 rounded-lg shadow-lg animate-bounce">
                            It's a Match with {matchNotification}!
                        </div>
                    )}
                    <div className="absolute top-4 right-4 z-20">
                        <button onClick={() => setFilterModalOpen(true)} className="p-3 bg-gray-800/70 rounded-full text-white hover:bg-gray-700">
                            <FilterIcon />
                        </button>
                    </div>
                    <div className="relative w-full max-w-sm h-[70vh] max-h-[600px]">
                        {loading ? <Loader /> : error ? <div className="p-4 text-center text-red-400">{error}</div> : profiles.length > 0 ? (
                            profiles.map((profile, index) => (
                                <TinderCard
                                    ref={childRefs[index]}
                                    className='tinder-card'
                                    key={profile.id}
                                    onSwipe={(dir) => swiped(dir, profile.id, index)}
                                    preventSwipe={['up', 'down']}
                                >
                                    <div className="relative w-full h-full rounded-2xl shadow-2xl bg-cover bg-center" style={{ backgroundImage: `url(${profile.profile_pic_url})` }}>
                                        <div className="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent"></div>
                                        <div className="absolute bottom-0 left-0 p-6 text-white">
                                            <h3 className="text-3xl font-bold">{profile.username}, {profile.age}</h3>
                                            <p className="text-lg">{profile.bio.substring(0, 100)}...</p>
                                        </div>
                                    </div>
                                </TinderCard>
                            ))
                        ) : (
                            <div className="text-center text-gray-400">
                                <h2 className="text-2xl font-bold mb-4">That's everyone for now!</h2>
                                <p>Try adjusting your filters or check back later for new profiles.</p>
                            </div>
                        )}
                    </div>
                     <div className="mt-8 flex space-x-8 z-10">
                        <button onClick={() => swipe('left')} className="p-5 rounded-full bg-red-500/20 text-red-500 hover:bg-red-500/40 transform transition-transform hover:scale-110"><XIcon className="w-8 h-8" fill="none"/></button>
                        <button onClick={() => swipe('right')} className="p-5 rounded-full bg-green-500/20 text-green-500 hover:bg-green-500/40 transform transition-transform hover:scale-110"><HeartIcon className="w-8 h-8" fill="none"/></button>
                    </div>
                    <FilterModal isOpen={isFilterModalOpen} onClose={() => setFilterModalOpen(false)} currentFilters={filters} onApply={handleApplyFilters} />
                </div>
            );
        };


        // --- Messages Screen Component ---
        const MessagesScreen = ({ userProfile, onChatSelect }) => {
            const [conversations, setConversations] = useState([]);
            const [requests, setRequests] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState('');
            const supabase = useSupabase();
            const isDominant = userProfile.profile_type === 'Type 1';

            useEffect(() => {
                const fetchConversations = async () => {
                    const { data, error } = await supabase.rpc('get_conversations');
                    if (error) {
                        setError('Failed to load conversations.');
                        console.error(error);
                    } else {
                        const convos = data.filter(c => c.last_message_content !== null);
                        const reqs = data.filter(c => c.last_message_content === null);

                        setConversations(convos);
                        if (isDominant) {
                            setRequests(reqs);
                        } else {
                            setConversations(prev => [...prev.filter(p => !reqs.some(r => r.match_id === p.match_id)), ...reqs]);
                        }
                    }
                    setLoading(false);
                };

                fetchConversations();
            }, [userProfile.id, supabase, isDominant]);

            const handleStartChat = async (match) => {
                // This function is for submissives to initiate a chat
                const { error } = await supabase.from('messages').insert({
                    match_id: match.match_id,
                    sender_id: userProfile.id,
                    content: `Hey! `,
                    message_type: 'text'
                });
                if (!error) {
                    onChatSelect({ partner: match.partner, matchId: match.match_id });
                } else {
                    console.error("Error starting chat:", error);
                }
            };

            if (loading) return <div className="p-4 flex justify-center items-center h-full"><Loader /></div>;
            if (error) return <div className="p-4 text-center text-red-400">{error}</div>;

            return (
                <div className="p-4">
                    <h1 className="text-3xl font-bold text-pink-500 mb-6">Messages</h1>
                    
                    {isDominant && requests.length > 0 && (
                        <div className="mb-8">
                            <h2 className="text-xl font-semibold text-gray-300 mb-4">New Requests</h2>
                            <div className="space-y-4">
                                {requests.map(req => (
                                    <div key={req.match_id} onClick={() => onChatSelect({ partner: req.partner, matchId: req.match_id })} className="flex items-center p-3 bg-gray-800 rounded-lg cursor-pointer hover:bg-gray-700">
                                        <img src={req.partner.profile_pic_url} alt={req.partner.username} className="w-14 h-14 rounded-full object-cover mr-4" />
                                        <div className="flex-grow">
                                            <h3 className="font-bold">{req.partner.username}</h3>
                                            <p className="text-sm text-gray-400 italic">New match! Waiting for them to message.</p>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    <h2 className="text-xl font-semibold text-gray-300 mb-4">Conversations</h2>
                    {conversations.length === 0 ? (
                        <p className="text-gray-400 text-center mt-12">No conversations yet.</p>
                    ) : (
                        <div className="space-y-4">
                            {conversations.map(convo => (
                                <div key={convo.match_id} onClick={() => convo.last_message_content ? onChatSelect({ partner: convo.partner, matchId: convo.match_id }) : null} className="flex items-center p-3 bg-gray-800 rounded-lg cursor-pointer hover:bg-gray-700">
                                    <img src={convo.partner.profile_pic_url} alt={convo.partner.username} className="w-14 h-14 rounded-full object-cover mr-4" />
                                    <div className="flex-grow">
                                        <h3 className="font-bold">{convo.partner.username}</h3>
                                        {convo.last_message_content ? (
                                            <p className="text-sm text-gray-400 truncate">{convo.last_message_content}</p>
                                        ) : (
                                            <button onClick={(e) => { e.stopPropagation(); handleStartChat(convo); }} className="text-sm bg-pink-600 px-3 py-1 rounded-full hover:bg-pink-700">Start Chat</button>
                                        )}
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        // --- Chat Screen Component ---
        const ChatScreen = ({ userProfile, partner, matchId, goBack }) => {
            const [messages, setMessages] = useState([]);
            const [newMessage, setNewMessage] = useState('');
            const [loading, setLoading] = useState(true);
            const [isMenuOpen, setMenuOpen] = useState(false);
            const [isGalleryModalOpen, setGalleryModalOpen] = useState(false);
            const [hasGalleryAccess, setHasGalleryAccess] = useState(false);
            const supabase = useSupabase();
            const messagesEndRef = useRef(null);
            const fileInputRef = useRef(null);

            const scrollToBottom = () => {
                messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
            };

            useEffect(() => {
                const fetchMessagesAndPermissions = async () => {
                    // Fetch messages
                    const { data: msgData, error: msgError } = await supabase
                        .from('messages')
                        .select('*')
                        .eq('match_id', matchId)
                        .order('created_at', { ascending: true });

                    if (msgError) console.error('Error fetching messages:', msgError);
                    else setMessages(msgData);
                    
                    // Check gallery permissions
                    const { data: permData, error: permError } = await supabase
                        .from('gallery_permissions')
                        .select('id')
                        .eq('granter_id', partner.id)
                        .eq('grantee_id', userProfile.id)
                        .single();

                    if (permData) setHasGalleryAccess(true);

                    setLoading(false);
                };
                fetchMessagesAndPermissions();
            }, [matchId, supabase, userProfile.id, partner.id]);

            useEffect(() => {
                const channel = supabase
                    .channel(`messages_${matchId}`)
                    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages', filter: `match_id=eq.${matchId}` }, payload => {
                        if (payload.new.message_type === 'system' && payload.new.content.includes('gallery access')) {
                            setHasGalleryAccess(true);
                        }
                        setMessages(currentMessages => [...currentMessages, payload.new]);
                    })
                    .subscribe();

                return () => {
                    supabase.removeChannel(channel);
                };
            }, [matchId, supabase]);

            useEffect(scrollToBottom, [messages]);
            
            const handleSendMessage = async (content, type = 'text') => {
                if (content.trim() === '') return;

                const messageData = {
                    match_id: matchId,
                    sender_id: userProfile.id,
                    content: content.trim(),
                    message_type: type
                };

                const { error } = await supabase.from('messages').insert(messageData);
                if (error) console.error('Error sending message:', error);
                else setNewMessage('');
            };
            
            const handleImageUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const filePath = `${userProfile.id}/${matchId}/${Date.now()}_${file.name}`;
                const { error: uploadError } = await supabase.storage.from('chat_images').upload(filePath, file);

                if (uploadError) {
                    console.error("Error uploading image:", uploadError);
                    return;
                }
                
                const { data: { publicUrl } } = supabase.storage.from('chat_images').getPublicUrl(filePath);
                handleSendMessage(publicUrl, 'image');
            };
            
            const handleGrantGalleryAccess = async () => {
                const { error } = await supabase.rpc('grant_gallery_access', { target_user_id: partner.id });
                if (error) {
                    console.error("Error granting gallery access:", error);
                } else {
                    // System message is now sent via RPC function
                    console.log("Gallery access granted.");
                }
                setMenuOpen(false);
            };

            const handleUnmatch = async () => {
                // In a real app, you'd want a confirmation modal here.
                const { error } = await supabase.rpc('unmatch_user', { target_user_id: partner.id });
                if (error) {
                    console.error("Error unmatching:", error);
                } else {
                    goBack(); // Go back to messages screen
                }
            };


            return (
                <div className="h-full flex flex-col">
                    {/* Header */}
                    <div className="flex items-center justify-between p-3 bg-gray-800 shadow-md">
                        <div className="flex items-center">
                           <button onClick={goBack} className="mr-4"><ArrowLeftIcon /></button>
                            <img src={partner.profile_pic_url} alt={partner.username} className="w-10 h-10 rounded-full object-cover mr-3" />
                            <h2 className="font-bold text-lg">{partner.username}</h2>
                        </div>
                        <div className="relative">
                            <button onClick={() => setMenuOpen(!isMenuOpen)}><MoreVerticalIcon /></button>
                            {isMenuOpen && (
                                <div className="absolute right-0 mt-2 w-48 bg-gray-700 rounded-md shadow-lg z-20">
                                    {hasGalleryAccess && <button onClick={() => { setGalleryModalOpen(true); setMenuOpen(false); }} className="block w-full text-left px-4 py-2 text-sm text-gray-200 hover:bg-gray-600">View Gallery</button>}
                                    <button onClick={handleGrantGalleryAccess} className="block w-full text-left px-4 py-2 text-sm text-gray-200 hover:bg-gray-600">Grant Gallery Access</button>
                                    <button onClick={handleUnmatch} className="block w-full text-left px-4 py-2 text-sm text-red-400 hover:bg-gray-600">Unmatch</button>
                                    <button onClick={() => { /* Open Report Modal */ setMenuOpen(false); }} className="block w-full text-left px-4 py-2 text-sm text-red-400 hover:bg-gray-600">Report</button>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* Messages Area */}
                    <div className="flex-grow p-4 overflow-y-auto bg-gray-900">
                        {loading ? <Loader /> : (
                            <div className="space-y-4">
                                {messages.map(msg => (
                                    <div key={msg.id} className={`flex ${msg.sender_id === userProfile.id ? 'justify-end' : 'justify-start'}`}>
                                        <div className={`max-w-xs lg:max-w-md px-4 py-2 rounded-2xl ${msg.sender_id === userProfile.id ? 'bg-pink-600 text-white rounded-br-none' : 'bg-gray-700 text-gray-200 rounded-bl-none'}`}>
                                            {msg.message_type === 'image' ? (
                                                <img src={msg.content} alt="Chat image" className="rounded-lg max-w-full h-auto" />
                                            ) : msg.message_type === 'system' ? (
                                                <p className="text-xs italic text-center text-gray-400">{msg.content}</p>
                                            ) : (
                                                <p>{msg.content}</p>
                                            )}
                                        </div>
                                    </div>
                                ))}
                                <div ref={messagesEndRef} />
                            </div>
                        )}
                    </div>

                    {/* Input Form */}
                    <div className="p-4 bg-gray-800">
                        <form onSubmit={(e) => { e.preventDefault(); handleSendMessage(newMessage); }} className="flex items-center space-x-3">
                            <input type="file" ref={fileInputRef} onChange={handleImageUpload} className="hidden" accept="image/*" />
                            <button type="button" onClick={() => fileInputRef.current.click()} className="p-3 text-gray-400 hover:text-white"><ImageIcon /></button>
                            <input
                                type="text"
                                value={newMessage}
                                onChange={e => setNewMessage(e.target.value)}
                                placeholder="Type a message..."
                                className="flex-grow bg-gray-700 rounded-full p-3 px-5 focus:outline-none"
                            />
                            <button type="submit" className="bg-pink-600 rounded-full p-3 text-white">
                                <SendIcon />
                            </button>
                        </form>
                    </div>
                    {hasGalleryAccess && <GalleryModal isOpen={isGalleryModalOpen} onClose={() => setGalleryModalOpen(false)} username={partner.username} imageUrls={partner.gallery_urls} />}
                </div>
            );
        };

        // --- Forum Components ---
        const CreatePostModal = ({ isOpen, onClose, userProfile }) => {
            const [title, setTitle] = useState('');
            const [content, setContent] = useState('');
            const [error, setError] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const supabase = useSupabase();

            const handleSubmit = async () => {
                if (!title || !content) {
                    setError('Title and content are required.');
                    return;
                }
                setIsLoading(true);
                setError('');
                const { error: insertError } = await supabase.from('posts').insert({
                    title,
                    content,
                    user_id: userProfile.id
                });
                if (insertError) {
                    setError('Failed to create post.');
                    console.error(insertError);
                } else {
                    setTitle('');
                    setContent('');
                    onClose();
                }
                setIsLoading(false);
            };

            return (
                <Modal isOpen={isOpen} onClose={onClose} title="Create a New Post">
                    <div className="space-y-4">
                        {error && <p className="text-red-400">{error}</p>}
                        <input type="text" placeholder="Post Title" value={title} onChange={e => setTitle(e.target.value)} className="w-full bg-gray-700 p-3 rounded-md" />
                        <textarea placeholder="What's on your mind?" value={content} onChange={e => setContent(e.target.value)} className="w-full bg-gray-700 p-3 rounded-md h-40"></textarea>
                        <button onClick={handleSubmit} disabled={isLoading} className="w-full bg-pink-600 hover:bg-pink-700 text-white font-bold py-2 px-4 rounded-md disabled:opacity-50">
                            {isLoading ? 'Posting...' : 'Create Post'}
                        </button>
                    </div>
                </Modal>
            );
        };

        const PostItem = ({ post, onPostSelect }) => {
            const supabase = useSupabase();
            const [likeCount, setLikeCount] = useState(post.like_count);

            const handleLike = async (e) => {
                e.stopPropagation(); // Prevent triggering onPostSelect
                const { data, error } = await supabase.rpc('increment_like', { post_id_arg: post.id });
                if (!error) {
                    setLikeCount(prev => prev + 1);
                } else {
                    console.error("Error liking post:", error);
                }
            };

            return (
                <div onClick={() => onPostSelect(post)} className="bg-gray-800 p-4 rounded-lg cursor-pointer hover:bg-gray-700/50 transition-colors">
                    <div className="flex items-center mb-3">
                        <img src={post.author.profile_pic_url} alt={post.author.username} className="w-10 h-10 rounded-full object-cover mr-3" />
                        <div>
                            <p className="font-semibold">{post.author.username}</p>
                            <p className="text-xs text-gray-400">{new Date(post.created_at).toLocaleString()}</p>
                        </div>
                    </div>
                    <h3 className="text-xl font-bold mb-2 text-pink-400">{post.title}</h3>
                    <p className="text-gray-300 truncate">{post.content}</p>
                    <div className="flex justify-between items-center mt-4 text-gray-400 text-sm">
                        <div className="flex items-center space-x-2">
                           <button onClick={handleLike} className="flex items-center space-x-1 hover:text-pink-500">
                                <ThumbsUpIcon /> <span>{likeCount}</span>
                            </button>
                            <div className="flex items-center space-x-1">
                                <MessageSquareIcon /> <span>{post.comment_count}</span>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const ForumScreen = ({ userProfile, onPostSelect }) => {
            const [posts, setPosts] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState('');
            const [isCreateModalOpen, setCreateModalOpen] = useState(false);
            const supabase = useSupabase();

            useEffect(() => {
                const fetchPosts = async () => {
                    const { data, error } = await supabase
                        .from('posts_with_counts')
                        .select('*, author:profiles(*)')
                        .order('created_at', { ascending: false });

                    if (error) {
                        setError('Failed to load forum posts.');
                        console.error(error);
                    } else {
                        setPosts(data);
                    }
                    setLoading(false);
                };
                fetchPosts();

                const channel = supabase
                    .channel('public:posts')
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'posts' }, fetchPosts)
                    .subscribe();

                return () => {
                    supabase.removeChannel(channel);
                };
            }, [supabase]);

            if (loading) return <div className="p-4 flex justify-center items-center h-full"><Loader /></div>;
            if (error) return <div className="p-4 text-center text-red-400">{error}</div>;

            return (
                <div className="p-4 pb-20">
                    <div className="flex justify-between items-center mb-6">
                        <h1 className="text-3xl font-bold text-pink-500">Community Forum</h1>
                        <button onClick={() => setCreateModalOpen(true)} className="bg-pink-600 hover:bg-pink-700 text-white font-bold py-2 px-4 rounded-md">Create Post</button>
                    </div>
                    {posts.length === 0 ? (
                        <p className="text-gray-400 text-center mt-12">No posts yet. Be the first to start a conversation!</p>
                    ) : (
                        <div className="space-y-4">
                            {posts.map(post => (
                                <PostItem key={post.id} post={post} onPostSelect={onPostSelect} />
                            ))}
                        </div>
                    )}
                    <CreatePostModal isOpen={isCreateModalOpen} onClose={() => setCreateModalOpen(false)} userProfile={userProfile} />
                </div>
            );
        };

        const PostDetailScreen = ({ userProfile, post, goBack }) => {
            const [comments, setComments] = useState([]);
            const [newComment, setNewComment] = useState('');
            const [loading, setLoading] = useState(true);
            const supabase = useSupabase();

            const fetchComments = useCallback(async () => {
                const { data, error } = await supabase
                    .from('comments')
                    .select('*, author:profiles(*)')
                    .eq('post_id', post.id)
                    .order('created_at', { ascending: true });

                if (error) console.error("Error fetching comments:", error);
                else setComments(data);
                setLoading(false);
            }, [post.id, supabase]);

            useEffect(() => {
                fetchComments();
                const channel = supabase
                    .channel(`comments_${post.id}`)
                    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'comments', filter: `post_id=eq.${post.id}` }, payload => {
                        // This is a simplified way to update. A more robust solution would fetch the author profile too.
                        fetchComments();
                    })
                    .subscribe();

                return () => {
                    supabase.removeChannel(channel);
                };
            }, [post.id, supabase, fetchComments]);

            const handleAddComment = async (e) => {
                e.preventDefault();
                if (newComment.trim() === '') return;
                const { error } = await supabase.from('comments').insert({
                    content: newComment,
                    post_id: post.id,
                    user_id: userProfile.id
                });
                if (error) console.error("Error adding comment:", error);
                else setNewComment('');
            };

            return (
                <div className="h-full flex flex-col">
                    <div className="flex items-center p-3 bg-gray-800 shadow-md">
                        <button onClick={goBack} className="mr-4"><ArrowLeftIcon /></button>
                        <h2 className="font-bold text-lg truncate">{post.title}</h2>
                    </div>
                    <div className="flex-grow p-4 overflow-y-auto bg-gray-900">
                        <div className="bg-gray-800 p-4 rounded-lg mb-6">
                            <div className="flex items-center mb-3">
                                <img src={post.author.profile_pic_url} alt={post.author.username} className="w-10 h-10 rounded-full object-cover mr-3" />
                                <div>
                                    <p className="font-semibold">{post.author.username}</p>
                                    <p className="text-xs text-gray-400">{new Date(post.created_at).toLocaleString()}</p>
                                </div>
                            </div>
                            <h1 className="text-2xl font-bold mb-4 text-pink-400">{post.title}</h1>
                            <p className="text-gray-300 whitespace-pre-wrap">{post.content}</p>
                        </div>
                        <h3 className="text-xl font-bold mb-4">Comments</h3>
                        {loading ? <Loader /> : (
                            <div className="space-y-4">
                                {comments.map(comment => (
                                    <div key={comment.id} className="bg-gray-800/50 p-3 rounded-lg">
                                        <div className="flex items-center mb-2">
                                            <img src={comment.author.profile_pic_url} alt={comment.author.username} className="w-8 h-8 rounded-full object-cover mr-3" />
                                            <div>
                                                <p className="font-semibold text-sm">{comment.author.username}</p>
                                                <p className="text-xs text-gray-500">{new Date(comment.created_at).toLocaleString()}</p>
                                            </div>
                                        </div>
                                        <p className="text-gray-300 pl-11">{comment.content}</p>
                                    </div>
                                ))}
                                {comments.length === 0 && <p className="text-gray-400">No comments yet.</p>}
                            </div>
                        )}
                    </div>
                    <div className="p-4 bg-gray-800">
                        <form onSubmit={handleAddComment} className="flex items-center space-x-3">
                            <input type="text" value={newComment} onChange={e => setNewComment(e.target.value)} placeholder="Add a comment..." className="flex-grow bg-gray-700 rounded-full p-3 px-5 focus:outline-none" />
                            <button type="submit" className="bg-pink-600 rounded-full p-3 text-white"><SendIcon /></button>
                        </form>
                    </div>
                </div>
            );
        };

        // --- Profile Screen Component ---
        const ProfileScreen = ({ userProfile, onLogout }) => {
            const [isEditing, setIsEditing] = useState(false);
            const [formData, setFormData] = useState({
                bio: userProfile.bio || '',
                social_links: userProfile.social_links || { fetlife: '', reddit: '', instagram: '' }
            });
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const [success, setSuccess] = useState('');
            const supabase = useSupabase();

            const handleInputChange = (e, field) => {
                setFormData({ ...formData, [field]: e.target.value });
            };

            const handleSocialChange = (e, platform) => {
                setFormData({
                    ...formData,
                    social_links: { ...formData.social_links, [platform]: e.target.value }
                });
            };

            const handleSaveChanges = async () => {
                setLoading(true);
                setError('');
                setSuccess('');
                try {
                    const { error } = await supabase
                        .from('profiles')
                        .update({
                            bio: formData.bio,
                            social_links: formData.social_links
                        })
                        .eq('id', userProfile.id);
                    
                    if (error) throw error;
                    setSuccess('Profile updated successfully!');
                    setIsEditing(false);
                    // Note: In a real app, you'd want to update the global userProfile state here
                } catch (err) {
                    setError('Failed to update profile.');
                    console.error(err);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="p-4 pb-20">
                    <div className="max-w-2xl mx-auto">
                        <div className="text-center mb-6">
                            <img src={userProfile.profile_pic_url} alt={userProfile.username} className="w-32 h-32 rounded-full object-cover mx-auto mb-4 border-4 border-pink-500" />
                            <h1 className="text-3xl font-bold">{userProfile.username}</h1>
                            <p className="text-gray-400">{userProfile.email}</p>
                        </div>

                        <div className="bg-gray-800 p-6 rounded-lg mb-6">
                            <h2 className="text-xl font-bold mb-4 text-pink-400">Bio</h2>
                            {isEditing ? (
                                <textarea
                                    value={formData.bio}
                                    onChange={(e) => handleInputChange(e, 'bio')}
                                    className="w-full bg-gray-700 p-3 rounded-md h-32 text-white"
                                />
                            ) : (
                                <p className="text-gray-300">{userProfile.bio}</p>
                            )}
                        </div>

                        <div className="bg-gray-800 p-6 rounded-lg mb-6">
                            <h2 className="text-xl font-bold mb-4 text-pink-400">Labels</h2>
                            <div className="flex flex-wrap gap-2">
                                {userProfile.labels.map(label => (
                                    <span key={label} className="px-3 py-1 rounded-full text-sm bg-gray-700 text-gray-200">{label}</span>
                                ))}
                            </div>
                        </div>

                        <div className="bg-gray-800 p-6 rounded-lg mb-6">
                            <h2 className="text-xl font-bold mb-4 text-pink-400">Social Links</h2>
                            {isEditing ? (
                                <div className="space-y-4">
                                    <input type="text" placeholder="Fetlife URL" value={formData.social_links.fetlife} onChange={e => handleSocialChange(e, 'fetlife')} className="w-full bg-gray-700 p-3 rounded-md" />
                                    <input type="text" placeholder="Reddit URL" value={formData.social_links.reddit} onChange={e => handleSocialChange(e, 'reddit')} className="w-full bg-gray-700 p-3 rounded-md" />
                                    <input type="text" placeholder="Instagram URL" value={formData.social_links.instagram} onChange={e => handleSocialChange(e, 'instagram')} className="w-full bg-gray-700 p-3 rounded-md" />
                                </div>
                            ) : (
                                <div className="space-y-2 text-gray-300">
                                    <p>Fetlife: {userProfile.social_links?.fetlife || 'Not set'}</p>
                                    <p>Reddit: {userProfile.social_links?.reddit || 'Not set'}</p>
                                    <p>Instagram: {userProfile.social_links?.instagram || 'Not set'}</p>
                                </div>
                            )}
                        </div>
                        
                        {error && <p className="text-red-400 text-center mb-4">{error}</p>}
                        {success && <p className="text-green-400 text-center mb-4">{success}</p>}

                        {isEditing ? (
                            <div className="flex gap-4">
                                <button onClick={() => setIsEditing(false)} className="w-full bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 rounded-md">Cancel</button>
                                <button onClick={handleSaveChanges} disabled={loading} className="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-md disabled:bg-gray-500">{loading ? 'Saving...' : 'Save Changes'}</button>
                            </div>
                        ) : (
                            <button onClick={() => setIsEditing(true)} className="w-full bg-pink-600 hover:bg-pink-700 text-white font-bold py-3 rounded-md">Edit Profile</button>
                        )}

                        <button onClick={onLogout} className="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-md mt-4">Logout</button>
                    </div>
                </div>
            );
        };


        // --- Report Modal Component ---
        const ReportModal = ({ isOpen, onClose, onSubmit, reportedUsername }) => {
            const [reason, setReason] = useState('');
            const [details, setDetails] = useState('');
            const [isLoading, setIsLoading] = useState(false);

            const handleSubmit = () => {
                if (!reason) {
                    // Replace alert with a better UI element in a real app
                    console.error("Please select a reason for the report.");
                    return;
                }
                onSubmit(reason, details);
                setReason('');
                setDetails('');
            };

            return (
                <Modal isOpen={isOpen} onClose={onClose} title={`Report ${reportedUsername}`}>
                    <div className="space-y-4">
                        <p className="text-sm text-gray-400">Please select a reason for reporting this user. Your report is anonymous.</p>
                        <div className="space-y-2">
                            {REPORT_REASONS.map(r => (
                                <button key={r} onClick={() => setReason(r)} className={`w-full text-left p-2 rounded-md text-sm ${reason === r ? 'bg-pink-600 text-white' : 'bg-gray-700'}`}>{r}</button>
                            ))}
                        </div>
                        <textarea value={details} onChange={e => setDetails(e.target.value)} placeholder="Provide additional details (optional)" className="w-full bg-gray-700 p-2 rounded-md h-24"></textarea>
                        <button onClick={handleSubmit} disabled={isLoading} className="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 rounded-md">Submit Report</button>
                    </div>
                </Modal>
            );
        };

        // --- App Content ---
        const AppContent = () => {
            const [session, setSession] = useState(null);
            const [userProfile, setUserProfile] = useState(null);
            const [loading, setLoading] = useState(true);
            const supabase = useSupabase();

            useEffect(() => {
                const fetchSession = async () => {
                    // Use the useSupabase hook to get the client
                    const { data: { session } } = await supabase.auth.getSession();
                    setSession(session);
                    setLoading(false);
                };
                
                fetchSession();

                const { data: authListener } = supabase.auth.onAuthStateChange((_event, session) => {
                    setSession(session);
                });

                return () => {
                    authListener.subscription.unsubscribe();
                };
            }, [supabase]);

            useEffect(() => {
                if (session?.user) {
                    const fetchProfile = async () => {
                        setLoading(true);
                        const { data, error } = await supabase
                            .from('profiles')
                            .select('*')
                            .eq('id', session.user.id)
                            .single();
                        
                        if (data) {
                            setUserProfile(data);
                        }
                        setLoading(false);
                    };
                    fetchProfile();
                } else {
                    setUserProfile(null);
                    setLoading(false);
                }
            }, [session, supabase]);

            if (loading) return <div className="h-screen w-screen bg-gray-900 flex justify-center items-center"><Loader /></div>;
            
            if (session?.user) {
                if (userProfile) {
                    return <MainApp user={session.user} userProfile={userProfile} />;
                } else {
                    return <OnboardingFlow user={session.user} />;
                }
            }
            
            return <AuthScreen />;
        }

        // --- App Entry Point ---
        function App() {
            return (
                <SupabaseProvider>
                    <AppContent />
                </SupabaseProvider>
            );
        }
        
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
